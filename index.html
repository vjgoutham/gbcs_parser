<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GBCS Message Parser</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Syne:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg: #0a0e1a;
    --bg2: #0f1526;
    --panel: #131929;
    --border: #1e2d4a;
    --accent: #00e5ff;
    --accent2: #7b61ff;
    --accent3: #00ff9d;
    --warn: #ff6b35;
    --text: #c8d8f0;
    --text-dim: #4a6080;
    --text-bright: #e8f4ff;
    --mono: 'Share Tech Mono', monospace;
    --sans: 'Syne', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* Glowing orb */
  body::after {
    content: '';
    position: fixed;
    top: -200px;
    right: -200px;
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, rgba(123,97,255,0.12) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 0 24px 60px;
  }

  /* Header */
  header {
    padding: 40px 0 32px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 40px;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
  }

  .logo-area h1 {
    font-size: clamp(28px, 5vw, 48px);
    font-weight: 800;
    color: var(--text-bright);
    letter-spacing: -1px;
    line-height: 1;
  }

  .logo-area h1 span {
    color: var(--accent);
    text-shadow: 0 0 30px rgba(0,229,255,0.5);
  }

  .logo-area p {
    margin-top: 8px;
    font-size: 13px;
    color: var(--text-dim);
    font-family: var(--mono);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(0,229,255,0.08);
    border: 1px solid rgba(0,229,255,0.2);
    color: var(--accent);
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 4px;
    letter-spacing: 1px;
  }

  .badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Main layout */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  @media (max-width: 768px) {
    .grid { grid-template-columns: 1fr; }
  }

  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    background: rgba(0,0,0,0.2);
  }

  .panel-title {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
  }

  .panel-title span {
    color: var(--accent);
  }

  .panel-body {
    padding: 20px;
  }

  /* Input area */
  .input-wrap {
    position: relative;
  }

  textarea {
    width: 100%;
    min-height: 180px;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--accent3);
    font-family: var(--mono);
    font-size: 13px;
    padding: 16px;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
    line-height: 1.6;
    letter-spacing: 0.5px;
  }

  textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(0,229,255,0.08);
  }

  textarea::placeholder {
    color: var(--text-dim);
    font-size: 12px;
  }

  /* Buttons */
  .btn-row {
    display: flex;
    gap: 10px;
    margin-top: 14px;
    flex-wrap: wrap;
  }

  button {
    font-family: var(--sans);
    font-weight: 600;
    font-size: 13px;
    padding: 10px 22px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.5px;
  }

  .btn-primary {
    background: var(--accent);
    color: #000;
  }

  .btn-primary:hover {
    background: #33eaff;
    box-shadow: 0 0 20px rgba(0,229,255,0.3);
    transform: translateY(-1px);
  }

  .btn-primary:active { transform: translateY(0); }

  .btn-secondary {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .btn-secondary:hover {
    border-color: var(--text-dim);
    color: var(--text);
  }

  .btn-danger {
    background: transparent;
    border: 1px solid rgba(255,107,53,0.3);
    color: var(--warn);
  }

  .btn-danger:hover {
    border-color: var(--warn);
    background: rgba(255,107,53,0.08);
  }

  /* Examples */
  .examples {
    margin-top: 16px;
  }

  .examples-label {
    font-size: 11px;
    color: var(--text-dim);
    font-family: var(--mono);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .example-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .chip {
    font-family: var(--mono);
    font-size: 11px;
    padding: 5px 10px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: rgba(123,97,255,0.06);
    color: var(--accent2);
    cursor: pointer;
    transition: all 0.15s;
  }

  .chip:hover {
    border-color: var(--accent2);
    background: rgba(123,97,255,0.12);
    transform: translateY(-1px);
  }

  /* Output panel */
  .output-panel {
    grid-column: 1 / -1;
  }

  .output-inner {
    display: none;
  }

  .output-inner.visible {
    display: block;
  }

  /* Result sections */
  .result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .result-card {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
  }

  .result-card.accent-blue  { border-left: 3px solid var(--accent); }
  .result-card.accent-purple { border-left: 3px solid var(--accent2); }
  .result-card.accent-green  { border-left: 3px solid var(--accent3); }
  .result-card.accent-warn   { border-left: 3px solid var(--warn); }

  .card-label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 8px;
  }

  .card-value {
    font-family: var(--mono);
    font-size: 14px;
    color: var(--text-bright);
    word-break: break-all;
  }

  .card-value.highlight { color: var(--accent); }
  .card-value.highlight-purple { color: var(--accent2); }
  .card-value.highlight-green { color: var(--accent3); }

  /* Hex dump */
  .hex-section {
    margin-top: 16px;
  }

  .section-title {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .hex-dump {
    background: rgba(0,0,0,0.5);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
    font-family: var(--mono);
    font-size: 12px;
    line-height: 1.8;
    overflow-x: auto;
    max-height: 280px;
    overflow-y: auto;
  }

  .hex-row {
    display: flex;
    gap: 16px;
    align-items: baseline;
  }

  .hex-addr { color: var(--text-dim); min-width: 44px; }
  .hex-bytes { color: var(--accent3); flex: 1; letter-spacing: 1px; }
  .hex-ascii { color: var(--text-dim); min-width: 140px; }

  /* MAC display */
  .mac-display {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--accent2);
    background: rgba(123,97,255,0.06);
    border: 1px solid rgba(123,97,255,0.2);
    border-radius: 6px;
    padding: 12px 16px;
    word-break: break-all;
    letter-spacing: 1px;
  }

  /* Errors */
  .error-box {
    background: rgba(255,107,53,0.06);
    border: 1px solid rgba(255,107,53,0.3);
    border-radius: 6px;
    padding: 14px 16px;
    color: var(--warn);
    font-family: var(--mono);
    font-size: 13px;
  }

  .error-box::before {
    content: '⚠ ';
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-dim);
  }

  .empty-state .icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.4;
  }

  .empty-state p {
    font-family: var(--mono);
    font-size: 13px;
    letter-spacing: 1px;
  }

  /* Animation */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .animate-in {
    animation: fadeIn 0.3s ease forwards;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* Footer */
  footer {
    margin-top: 60px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
    text-align: center;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 1px;
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="logo-area">
      <h1>GBCS <span>Parser</span></h1>
      <p>Great Britain Companion Specification // Message Decoder</p>
    </div>
    <div class="badge">SMETS2 / DCC Compatible</div>
  </header>

  <div class="grid">

    <!-- Input Panel -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title"><span>//</span> Input</span>
        <span class="panel-title">HEX MESSAGE</span>
      </div>
      <div class="panel-body">
        <div class="input-wrap">
          <textarea id="hexInput" placeholder="Paste GBCS hex message here&#10;e.g. DD 82 00 44 09 0A 00 00 00 00 ...&#10;&#10;Spaces and colons are ignored."></textarea>
        </div>
        <div class="btn-row">
          <button class="btn-primary" onclick="parseMessage()">▶ Parse Message</button>
          <button class="btn-secondary" onclick="loadDemo()">Load Demo</button>
          <button class="btn-danger" onclick="clearAll()">Clear</button>
        </div>
        <div class="examples">
          <div class="examples-label">Quick Examples</div>
          <div class="example-chips">
            <span class="chip" onclick="loadExample('signing')">General Signing (0xDD)</span>
            <span class="chip" onclick="loadExample('ciphering')">General Ciphering (0xDB)</span>
            <span class="chip" onclick="loadExample('glo')">GLO Ciphering (0xD8)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Info Panel -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title"><span>//</span> Reference</span>
        <span class="panel-title">MESSAGE TYPES</span>
      </div>
      <div class="panel-body">
        <table style="width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;">
          <thead>
            <tr style="color:var(--text-dim)">
              <th style="text-align:left;padding:6px 0;border-bottom:1px solid var(--border)">TAG</th>
              <th style="text-align:left;padding:6px 0;border-bottom:1px solid var(--border)">TYPE</th>
              <th style="text-align:left;padding:6px 0;border-bottom:1px solid var(--border)">DESCRIPTION</th>
            </tr>
          </thead>
          <tbody>
            <tr><td style="padding:7px 0;color:var(--accent)">0xDD</td><td style="padding:7px 0;color:var(--text)">General Signing</td><td style="padding:7px 0;color:var(--text-dim)">Signed, unencrypted</td></tr>
            <tr><td style="padding:7px 0;color:var(--accent)">0xDB</td><td style="padding:7px 0;color:var(--text)">General Ciphering</td><td style="padding:7px 0;color:var(--text-dim)">Authenticated encryption</td></tr>
            <tr><td style="padding:7px 0;color:var(--accent)">0xD8</td><td style="padding:7px 0;color:var(--text)">GLO Ciphering</td><td style="padding:7px 0;color:var(--text-dim)">Global key ciphered</td></tr>
            <tr><td style="padding:7px 0;color:var(--accent)">0xD9</td><td style="padding:7px 0;color:var(--text)">DED Ciphering</td><td style="padding:7px 0;color:var(--text-dim)">Dedicated key ciphered</td></tr>
          </tbody>
        </table>

        <div style="margin-top:20px">
          <div class="section-title">Message Codes</div>
          <div style="font-family:var(--mono);font-size:12px;display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;color:var(--text-dim)">
            <span><span style="color:var(--accent2)">0x0001</span> CS01a — Read Import Reg</span>
            <span><span style="color:var(--accent2)">0x0002</span> CS02a — Read Billing</span>
            <span><span style="color:var(--accent2)">0x0004</span> CS04 — Prepayment Status</span>
            <span><span style="color:var(--accent2)">0x0101</span> ECS01a — Supplier Info</span>
            <span><span style="color:var(--accent2)">0x0111</span> ECS17a — Join</span>
            <span><span style="color:var(--accent2)">0x0201</span> GCS01a — Activate FW</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Output Panel -->
    <div class="panel output-panel">
      <div class="panel-header">
        <span class="panel-title"><span>//</span> Output</span>
        <span class="panel-title" id="outputStatus">AWAITING INPUT</span>
      </div>
      <div class="panel-body">
        <div id="emptyState" class="empty-state">
          <div class="icon">⬡</div>
          <p>Paste a GBCS hex message above and click Parse</p>
        </div>
        <div id="outputInner" class="output-inner"></div>
      </div>
    </div>

  </div>

  <footer>
    GBCS Message Parser // vjgoutham // SMETS2 Smart Metering // UK DCC Infrastructure
  </footer>
</div>

<script>
// ─── GBCS Parser Logic ─────────────────────────────────────────────────────

const MESSAGE_CODES = {
  0x0001: 'CS01a — Read Instantaneous Import Register(s)',
  0x0002: 'CS02a — Read Billing Data Log',
  0x0004: 'CS04 — Read Prepayment Status',
  0x0006: 'CS06a — Read MPAN',
  0x0101: 'ECS01a — Write Supplier Contact Details',
  0x0111: 'ECS17a — Join (ESME)',
  0x0201: 'GCS01a — Activate Firmware',
  0x020D: 'GCS13a — Read Device Join Details',
};

const TAG_NAMES = {
  0xDD: 'General Signing',
  0xDB: 'General Ciphering',
  0xD8: 'GLO Ciphering',
  0xD9: 'DED Ciphering',
};

const SIGNED_TAGS   = new Set([0xDD]);
const CIPHERED_TAGS = new Set([0xDB, 0xD8, 0xD9]);
const MAC_LEN = 12;

function decodeLength(bytes, offset) {
  const first = bytes[offset];
  if (first < 0x80) return { length: first, consumed: 1 };
  const numBytes = first & 0x7F;
  let length = 0;
  for (let i = 0; i < numBytes; i++) {
    length = (length << 8) | bytes[offset + 1 + i];
  }
  return { length, consumed: 1 + numBytes };
}

function readOctetString(bytes, offset, expectedTag = 0x09) {
  if (bytes[offset] !== expectedTag) {
    throw new Error(`Expected tag 0x${expectedTag.toString(16).toUpperCase()} at offset ${offset}, got 0x${bytes[offset].toString(16).toUpperCase()}`);
  }
  offset++;
  const { length, consumed } = decodeLength(bytes, offset);
  offset += consumed;
  const value = bytes.slice(offset, offset + length);
  return { value, nextOffset: offset + length };
}

function parseSystemTitle(bytes) {
  if (bytes.length < 8) return toHex(bytes);
  try {
    const mfr = String.fromCharCode(bytes[0], bytes[1], bytes[2]);
    let serial = 0n;
    for (let i = 3; i < 8; i++) serial = (serial << 8n) | BigInt(bytes[i]);
    return `${mfr}-${serial.toString().padStart(10, '0')}`;
  } catch { return toHex(bytes); }
}

function parseDateTime(bytes) {
  if (bytes.length < 4) return toHex(bytes);
  const ts = (bytes[0] << 24 | bytes[1] << 16 | bytes[2] << 8 | bytes[3]) >>> 0;
  try {
    return new Date(ts * 1000).toISOString().replace('.000Z','Z');
  } catch { return `epoch=${ts}`; }
}

function toHex(bytes, sep = ' ') {
  return Array.from(bytes).map(b => b.toString(16).toUpperCase().padStart(2,'0')).join(sep);
}

function parseGBCS(hexStr) {
  const bytes = new Uint8Array(hexStr.replace(/[\s:]/g,'').match(/.{2}/g).map(h => parseInt(h,16)));
  const result = { raw: bytes, tag: bytes[0], errors: [], mac: new Uint8Array(), payload: new Uint8Array(), header: null };

  const { length, consumed } = decodeLength(bytes, 1);
  result.length = length;
  let offset = 1 + consumed;

  if (SIGNED_TAGS.has(result.tag)) {
    parseGeneralSigning(bytes, offset, result);
  } else if (CIPHERED_TAGS.has(result.tag)) {
    parseGeneralCiphering(bytes, offset, result);
  } else {
    result.errors.push(`Unknown top-level tag: 0x${result.tag.toString(16).toUpperCase()}`);
    result.payload = bytes.slice(offset);
  }

  return result;
}

function parseGeneralSigning(bytes, offset, result) {
  try {
    let r;
    r = readOctetString(bytes, offset); const txId = r.value; offset = r.nextOffset;
    r = readOctetString(bytes, offset); const origSys = r.value; offset = r.nextOffset;
    r = readOctetString(bytes, offset); const recvSys = r.value; offset = r.nextOffset;
    r = readOctetString(bytes, offset); const dateTime = r.value; offset = r.nextOffset;
    r = readOctetString(bytes, offset); const otherInfo = r.value; offset = r.nextOffset;

    const contentTag = bytes[offset]; offset++;
    const cl = decodeLength(bytes, offset); offset += cl.consumed;
    const payload = bytes.slice(offset, offset + cl.length); offset += cl.length;

    r = readOctetString(bytes, offset); const mac = r.value;

    const msgCode = txId.length >= 6 ? (txId[4] << 8 | txId[5]) : 0;

    result.header = {
      transactionId: txId,
      originator: origSys,
      recipient: recvSys,
      dateTime,
      otherInfo,
      messageCode: msgCode,
      keyInfo: null,
      frameCounter: null,
      securityControl: null,
    };
    result.payload = payload;
    result.mac = mac;
  } catch(e) {
    result.errors.push('General signing parse error: ' + e.message);
  }
}

function parseGeneralCiphering(bytes, offset, result) {
  try {
    let r = readOctetString(bytes, offset); const sysTitle = r.value; offset = r.nextOffset;
    const cl = decodeLength(bytes, offset); offset += cl.consumed;

    const secControl = bytes[offset]; offset++;
    const frameCounter = (bytes[offset]<<24|bytes[offset+1]<<16|bytes[offset+2]<<8|bytes[offset+3])>>>0;
    offset += 4;

    const remaining = bytes.slice(offset, offset + cl.length - 5);
    const payload = remaining.slice(0, remaining.length - MAC_LEN);
    const mac = remaining.slice(remaining.length - MAC_LEN);

    result.header = {
      transactionId: null,
      originator: sysTitle,
      recipient: null,
      dateTime: null,
      otherInfo: null,
      messageCode: 0,
      keyInfo: sysTitle,
      frameCounter,
      securityControl: secControl,
    };
    result.payload = payload;
    result.mac = mac;
  } catch(e) {
    result.errors.push('General ciphering parse error: ' + e.message);
  }
}

// ─── Hex Dump ───────────────────────────────────────────────────────────────

function buildHexDump(bytes) {
  if (!bytes || bytes.length === 0) return '<span style="color:var(--text-dim)">— empty —</span>';
  let html = '';
  for (let i = 0; i < bytes.length; i += 16) {
    const chunk = bytes.slice(i, i + 16);
    const addr = i.toString(16).toUpperCase().padStart(4,'0');
    const hexPart = Array.from(chunk).map(b=>b.toString(16).toUpperCase().padStart(2,'0')).join(' ').padEnd(47,' ');
    const ascPart = Array.from(chunk).map(b => b>=0x20&&b<0x7F ? String.fromCharCode(b) : '.').join('');
    html += `<div class="hex-row"><span class="hex-addr">${addr}</span><span class="hex-bytes">${hexPart}</span><span class="hex-ascii">${ascPart}</span></div>`;
  }
  return html;
}

// ─── Render ─────────────────────────────────────────────────────────────────

function renderResult(result) {
  const tagName = TAG_NAMES[result.tag] || `Unknown (0x${result.tag.toString(16).toUpperCase()})`;
  let html = '<div class="animate-in">';

  if (result.errors.length > 0) {
    html += result.errors.map(e => `<div class="error-box">${e}</div>`).join('');
    if (!result.header && result.payload.length === 0) { html += '</div>'; return html; }
  }

  // Summary cards
  html += '<div class="result-grid">';
  html += `<div class="result-card accent-blue"><div class="card-label">Message Type</div><div class="card-value highlight">0x${result.tag.toString(16).toUpperCase()} — ${tagName}</div></div>`;
  html += `<div class="result-card accent-blue"><div class="card-label">Total Length</div><div class="card-value highlight">${result.raw.length} bytes</div></div>`;

  if (result.header) {
    const h = result.header;
    if (h.transactionId) {
      html += `<div class="result-card accent-purple"><div class="card-label">Transaction ID</div><div class="card-value" style="font-size:12px">${toHex(h.transactionId)}</div></div>`;
      const mc = h.messageCode;
      const mcName = MESSAGE_CODES[mc] || 'Unknown';
      html += `<div class="result-card accent-purple"><div class="card-label">Message Code</div><div class="card-value highlight-purple">0x${mc.toString(16).toUpperCase().padStart(4,'0')} — ${mcName}</div></div>`;
    }
    if (h.originator) {
      html += `<div class="result-card accent-green"><div class="card-label">Originator System Title</div><div class="card-value highlight-green">${parseSystemTitle(h.originator)}</div></div>`;
    }
    if (h.recipient && h.recipient.length > 0) {
      html += `<div class="result-card accent-green"><div class="card-label">Recipient System Title</div><div class="card-value highlight-green">${parseSystemTitle(h.recipient)}</div></div>`;
    }
    if (h.dateTime && h.dateTime.length > 0) {
      html += `<div class="result-card accent-blue"><div class="card-label">Timestamp</div><div class="card-value">${parseDateTime(h.dateTime)}</div></div>`;
    }
    if (h.frameCounter !== null) {
      html += `<div class="result-card accent-purple"><div class="card-label">Frame Counter</div><div class="card-value highlight-purple">${h.frameCounter} (0x${h.frameCounter.toString(16).toUpperCase()})</div></div>`;
      html += `<div class="result-card accent-purple"><div class="card-label">Security Control</div><div class="card-value highlight-purple">0x${h.securityControl.toString(16).toUpperCase().padStart(2,'0')}</div></div>`;
    }
  }
  html += '</div>';

  // Payload hex dump
  html += '<div class="hex-section">';
  html += `<div class="section-title">Payload (${result.payload.length} bytes)</div>`;
  html += `<div class="hex-dump">${buildHexDump(result.payload)}</div>`;
  html += '</div>';

  // MAC
  html += '<div class="hex-section">';
  html += `<div class="section-title">MAC — Message Authentication Code (${result.mac.length} bytes)</div>`;
  html += `<div class="mac-display">${toHex(result.mac)}</div>`;
  html += '</div>';

  html += '</div>';
  return html;
}

// ─── UI Actions ─────────────────────────────────────────────────────────────

function parseMessage() {
  const input = document.getElementById('hexInput').value.trim();
  if (!input) { alert('Please paste a GBCS hex message first.'); return; }

  const out = document.getElementById('outputInner');
  const empty = document.getElementById('emptyState');
  const status = document.getElementById('outputStatus');

  try {
    const result = parseGBCS(input);
    out.innerHTML = renderResult(result);
    out.classList.add('visible');
    empty.style.display = 'none';
    status.textContent = result.errors.length ? 'PARSED WITH WARNINGS' : 'PARSED OK';
  } catch(e) {
    out.innerHTML = `<div class="animate-in"><div class="error-box">Failed to parse: ${e.message}</div></div>`;
    out.classList.add('visible');
    empty.style.display = 'none';
    status.textContent = 'PARSE ERROR';
  }
}

function clearAll() {
  document.getElementById('hexInput').value = '';
  document.getElementById('outputInner').innerHTML = '';
  document.getElementById('outputInner').classList.remove('visible');
  document.getElementById('emptyState').style.display = 'block';
  document.getElementById('outputStatus').textContent = 'AWAITING INPUT';
}

function loadDemo() {
  loadExample('signing');
  parseMessage();
}

// Build a synthetic General Signing message for demo
function buildSyntheticSigning() {
  function octetString(data) {
    const d = data instanceof Uint8Array ? data : new Uint8Array(data);
    return new Uint8Array([0x09, d.length, ...d]);
  }
  function encLen(n) {
    if (n < 0x80) return new Uint8Array([n]);
    const b = Math.ceil(Math.log2(n+1)/8);
    const arr = [0x80|b];
    for(let i=b-1;i>=0;i--) arr.push((n>>(i*8))&0xFF);
    return new Uint8Array(arr);
  }

  const txId    = new Uint8Array([0,0,0,0, 0x00,0x01, 0,0,0,1]);
  const origSys = new Uint8Array([0x41,0x42,0x43, 0,0,0xBC,0x61,0x4E]); // ABC-12345678
  const recvSys = new Uint8Array([0x58,0x59,0x5A, 0,0x53,0x82,0x1B,0x51]); // XYZ-87654321
  const ts      = Math.floor(Date.now()/1000);
  const dtBytes = new Uint8Array([(ts>>24)&0xFF,(ts>>16)&0xFF,(ts>>8)&0xFF,ts&0xFF]);
  const other   = new Uint8Array([0x00,0x00]);
  const payload = new Uint8Array([0x01,0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08]);
  const mac     = new Uint8Array(12);

  const inner = new Uint8Array([
    ...octetString(txId),
    ...octetString(origSys),
    ...octetString(recvSys),
    ...octetString(dtBytes),
    ...octetString(other),
    0x09, payload.length, ...payload,
    ...octetString(mac),
  ]);

  return new Uint8Array([0xDD, ...encLen(inner.length), ...inner]);
}

const EXAMPLES = {
  signing: () => {
    const bytes = buildSyntheticSigning();
    return Array.from(bytes).map(b=>b.toString(16).toUpperCase().padStart(2,'0')).join(' ');
  },
  ciphering: () =>
    'DB 09 08 41 42 43 00 00 BC 61 4E 82 00 32 30 00000001' +
    ' DE AD BE EF CA FE BA BE 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 10' +
    ' 11 12 13 14 15 16 17 18 19 1A 1B 1C 1D 1E 1F 20' +
    ' AA BB CC DD EE FF 00 11 22 33 44 55',
  glo: () =>
    'D8 09 08 58 59 5A 00 53 82 1B 51 82 00 28 28 00000002' +
    ' CA FE BA BE 01 02 03 04 05 06 07 08 09 0A 0B 0C' +
    ' DD EE FF 00 11 22 33 44 55 66 77 88',
};

function loadExample(name) {
  const fn = EXAMPLES[name];
  if (fn) {
    document.getElementById('hexInput').value = fn();
    parseMessage();
  }
}

// Allow Ctrl+Enter to parse
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') parseMessage();
});
</script>
</body>
</html>
